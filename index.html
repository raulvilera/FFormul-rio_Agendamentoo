<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AGENDAMENTO DE APARELHOS - SOLUÇÃO</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --azul-escuro: #0a2463;
      --azul-medio: #3e92cc;
      --azul-claro: #d6eaff;
      --verde: #4caf50;
      --vermelho: #f44336;
      --cinza-escuro: #333;
      --cinza-claro: #f5f5f5;
      --cinza-input: #f0f0f0;
      --branco: #ffffff;
      --branco-brilhante: rgba(255, 255, 255, 0.9);
      --verde-disponivel: #2ecc71;
      --azul-agendado: #3498db;
      --azul-selecionado: #1a5276;
      --fundo-cinza: #f0f0f0;
      --entregue: #d4edda;
      --nao-entregue: #f8d7da;
      --expirado: #fff3cd;
      --recente: #ffebee;
      --destaque-aula: #fff176;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(to bottom, var(--azul-escuro) 0%, var(--azul-escuro) 50%, #111 50%, #111 100%);
      color: var(--cinza-claro);
      min-height: 100vh;
      padding: 20px;
    }

    h2 {
      color: var(--branco);
      margin-bottom: 20px;
      text-align: center;
      text-transform: uppercase;
      font-size: 2rem;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    h3 {
      color: #000000;
      margin: 0.4cm 0;
      text-align: center;
      text-transform: uppercase;
      font-size: 0.9em;
      background-color: var(--azul-claro);
      padding: 8px;
      border-radius: 5px;
      font-weight: 600;
    }

    .container {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      max-width: 1800px;
      margin: 0 auto;
    }

    .form-container {
      flex: 1;
      min-width: 300px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      color: var(--cinza-escuro);
    }

    .calendar-container {
      flex: 1;
      min-width: 300px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      color: var(--cinza-escuro);
      overflow: auto;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 1.5rem;
    }

    .form-group {
      flex: 1;
      min-width: 220px;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--azul-escuro);
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background-color: var(--cinza-input);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--azul-medio);
      box-shadow: 0 0 0 3px rgba(62, 146, 204, 0.2);
      outline: none;
    }

    .calendar {
      width: 100%;
      border-collapse: separate;
      border-spacing: 8px;
      margin-top: 20px;
      margin-bottom: 0.4cm;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .calendar th,
    .calendar td {
      width: 45px;
      height: 45px;
      text-align: center;
      vertical-align: middle;
      border-radius: 10px;
      background-color: var(--branco);
      padding: 12px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .calendar th {
      background-color: var(--azul-escuro);
      color: white;
      font-weight: 500;
      padding: 12px;
    }

    .calendar td.disponivel {
      background-color: var(--verde-disponivel);
      color: white;
      cursor: default;
    }

    .calendar td.agendado {
      background-color: var(--azul-agendado);
      color: white;
      cursor: default;
    }

    .calendar td.selecionado {
      background-color: var(--azul-selecionado);
      color: white;
      font-weight: bold;
      cursor: default;
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    .calendar td.indisponivel {
      background-color: #e9ecef;
      cursor: not-allowed;
      color: #868e96;
    }

    .calendar td.aula-professor {
      background-color: var(--destaque-aula);
      font-weight: bold;
      position: relative;
    }

    .calendar td.aula-professor::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background-color: #f57c00;
      border-radius: 50%;
    }

    .calendar td:hover:not(.indisponivel) {
      opacity: 0.8;
    }

    .historico-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 0.85rem;
    }

    .historico-table th,
    .historico-table td {
      border: 1px solid #dee2e6;
      padding: 10px 8px;
      text-align: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .historico-table th {
      background-color: var(--azul-escuro);
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
    }

    .historico-table td {
      color: #495057;
    }

    .historico-table tr.excluido td {
      color: var(--vermelho);
      text-decoration: line-through;
    }

    .historico-table tr.entregue {
      background-color: var(--entregue);
    }

    .historico-table tr.nao-entregue {
      background-color: var(--nao-entregue);
    }
    
    .historico-table tr.expirado {
      background-color: var(--expirado);
    }
    
    .historico-table tr.recente {
      background-color: var(--recente);
    }

    .historico-table th:nth-child(1),
    .historico-table td:nth-child(1) {
      width: 10%;
    }

    .historico-table th:nth-child(2),
    .historico-table td:nth-child(2) {
      width: 15%;
    }

    .historico-table th:nth-child(3),
    .historico-table td:nth-child(3) {
      width: 8%;
    }

    .historico-table th:nth-child(4),
    .historico-table td:nth-child(4) {
      width: 12%;
    }

    .historico-table th:nth-child(5),
    .historico-table td:nth-child(5) {
      width: 20%;
    }

    .historico-table th:nth-child(6),
    .historico-table td:nth-child(6) {
      width: 10%;
    }
    
    .historico-table th:nth-child(7),
    .historico-table td:nth-child(7) {
      width: 10%;
    }
    
    .historico-table th:nth-child(8),
    .historico-table td:nth-child(8) {
      width: 15%;
    }

    .buttons-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
    }

    .btn-cadastrar {
      background-color: var(--azul-medio);
      color: white;
    }

    .btn-cadastrar:hover {
      background-color: #2c7ebd;
    }

    .btn-cadastrar:active {
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    .btn-limpar {
      background-color: #f0f0f0;
      color: #333;
    }

    .btn-limpar:hover {
      background-color: #e0e0e0;
    }

    .btn-limpar:active {
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    .btn-excluir {
      background-color: var(--vermelho);
      color: white;
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .btn-excluir:hover {
      background-color: #d32f2f;
    }

    .btn-excluir:active {
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }
    
    .btn-entregar {
      background-color: var(--verde);
      color: white;
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .btn-entregar:hover {
      background-color: #3d8b40;
    }

    .datepicker-container {
      position: relative;
    }

    .datepicker-popup {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 1000;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      width: 300px;
    }

    .datepicker-popup.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .datepicker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .datepicker-nav {
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      color: var(--azul-escuro);
    }

    .datepicker-nav:hover {
      background-color: var(--azul-claro);
    }

    .datepicker-title {
      font-weight: 600;
      color: var(--azul-escuro);
      font-size: 1.1rem;
    }

    .datepicker-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .datepicker-weekday {
      text-align: center;
      font-weight: 600;
      padding: 8px 0;
      color: var(--azul-escuro);
      font-size: 0.9rem;
    }

    .datepicker-day {
      text-align: center;
      padding: 8px 0;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.2s;
      font-weight: 500;
    }

    .datepicker-day:hover {
      background-color: var(--azul-claro);
    }

    .datepicker-day.selected {
      background-color: var(--azul-medio);
      color: white;
      font-weight: 600;
    }

    .datepicker-day.disabled {
      color: #ccc;
      cursor: not-allowed;
    }

    .datepicker-day.today {
      position: relative;
      color: var(--azul-medio);
      font-weight: 700;
    }

    .datepicker-day.today::after {
      content: '';
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background-color: var(--azul-medio);
      border-radius: 50%;
    }

    .datepicker-day.other-month {
      color: #aaa;
    }

    .datepicker-input {
      cursor: pointer;
      background-color: var(--cinza-input);
    }

    .conflict-message {
      color: var(--vermelho);
      font-weight: bold;
      margin-top: 15px;
      text-align: center;
      display: none;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 5px;
      border-left: 4px solid var(--vermelho);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 25px;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      position: relative;
    }

    .close {
      color: #aaa;
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
    }

    .close:hover {
      color: #000;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .export-buttons {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-disponivel {
      background-color: var(--verde-disponivel);
    }
    
    .status-agendado {
      background-color: var(--azul-agendado);
    }
    
    .status-entregue {
      background-color: var(--verde);
    }
    
    .status-excluido {
      background-color: var(--vermelho);
    }

    .aula-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .aula-checkbox {
      display: none;
    }

    .aula-label {
      display: inline-block;
      padding: 8px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      background-color: #f9f9f9;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .aula-checkbox:checked + .aula-label {
      background-color: var(--azul-medio);
      color: white;
      border-color: var(--azul-medio);
    }

    .aula-professor {
      background-color: var(--destaque-aula);
    }

    .aula-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
      }
      
      .calendar-container {
        max-height: 600px;
      }
      
      .historico-table {
        font-size: 0.8rem;
      }
    }
    
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .buttons-container {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }

    .solution-banner {
      background-color: #4caf50;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .solution-banner i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    
    /* Ajustes para inputs com tamanho da informação */
    .form-group input, 
    .form-group select {
      width: auto;
      min-width: 100%;
      box-sizing: border-box;
    }
    
    .datepicker-input {
      width: 100%;
    }
    
    /* Melhorias visuais */
    .calendar td {
      font-weight: 500;
    }
    
    .calendar th {
      font-weight: 600;
    }
    
    .form-container {
      background-color: rgba(255, 255, 255, 0.98);
    }
    
    .calendar-container {
      background-color: rgba(255, 255, 255, 0.98);
    }
  </style>
</head>
<body>
  <h2>AGENDAMENTO DE APARELHOS</h2>
  
  <!-- Exemplo com link direto (após hospedar a imagem) -->
<div class="solution-banner">
  <i class="fas fa-check-circle"></i>
  <img src="https://exemplo.com/sua-imagem-direta.jpg" alt="Descrição da imagem">
</div>
  
  <div class="container">
    <div class="form-container">
      <div class="form-row">
        <div class="form-group">
          <label>PROFESSOR:</label>
          <select id="professor" onchange="atualizarEmailEAulas()">
            <option>Selecione</option>
          </select>
        </div>
        <div class="form-group">
          <label>EMAIL:</label>
          <input type="email" id="email-professor" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>APARELHO:</label>
          <select id="equipamentoAgendamento" onchange="atualizarMarca()">
            <option value="">Selecione</option>
            <option value="TABLET">TABLET</option>
            <option value="SMARTPHONE">SMARTPHONE</option>
            <option value="CHROMEBOOK">CHROMEBOOK</option>
            <option value="NOTEBOOK">NOTEBOOK</option>
          </select>
        </div>

        <div class="form-group">
          <label>MARCA:</label>
          <input type="text" id="marca" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>N° DE APARELHOS:</label>
          <input type="number" id="quantidadeAgendamento" min="1" value="1">
        </div>
        
        <div class="form-group datepicker-container">
          <label>DATA:</label>
          <input type="text" id="dataAgendamento" class="datepicker-input" readonly placeholder="Clique para selecionar">
          <div class="datepicker-popup" id="datepickerPopup">
            <div class="datepicker-header">
              <button class="datepicker-nav" id="prevMonth">&lt;</button>
              <div class="datepicker-title" id="datepickerMonthYear"></div>
              <button class="datepicker-nav" id="nextMonth">&gt;</button>
            </div>
            <div class="datepicker-grid" id="datepickerWeekdays"></div>
            <div class="datepicker-grid" id="datepickerDays"></div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>TURMA:</label>
          <select id="studentClass" class="form-control" required onchange="atualizarSalaEAulas()">
            <option value="">Selecione a turma</option>
            <option value="6° ANO A MANHA">6° ANO A MANHA</option>
            <option value="6° ANO B MANHA">6° ANO B MANHA</option>
            <option value="6° ANO C MANHA">6° ANO C MANHA</option>
            <option value="6° ANO D MANHA">6° ANO D MANHA</option>
            <option value="6° ANO E TARDE">6° ANO E TARDE</option>
            <option value="6° ANO F TARDE">6° ANO F TARDE</option>
            <option value="7° ANO A TARDE">7° ANO A TARDE</option>
            <option value="7° ANO B TARDE">7° ANO B TARDE</option>
            <option value="7° ANO C TARDE">7° ANO C TARDE</option>
            <option value="7° ANO D TARDE">7° ANO D TARDE</option>
            <option value="7° ANO E TARDE">7° ANO E TARDE</option>
            <option value="7° ANO F TARDE">7° ANO F TARDE</option>
            <option value="8° ANO A TARDE">8° ANO A TARDE</option>
            <option value="8° ANO B TARDE">8° ANO B TARDE</option>
            <option value="8° ANO C TARDE">8° ANO C TARDE</option>
            <option value="8° ANO D TARDE">8° ANO D TARDE</option>
            <option value="8° ANO E TARDE">8° ANO E TARDE</option>
            <option value="9° ANO A TARDE">9° ANO A TARDE</option>
            <option value="9° ANO B TARDE">9° ANO B TARDE</option>
            <option value="9° ANO C TARDE">9° ANO C TARDE</option>
            <option value="9° ANO D TARDE">9° ANO D TARDE</option>
            <option value="1ª SERIE A MANHA">1ª SERIE A MANHA</option>
            <option value="1ª SERIE B MANHA">1ª SERIE B MANHA</option>
            <option value="1ª SERIE C MANHA">1ª SERIE C MANHA</option>
            <option value="1ª SERIE D MANHA">1ª SERIE D MANHA</option>
            <option value="1ª SERIE E MANHA">1ª SERIE E MANHA</option>
            <option value="1ª SERIE F MANHA">1ª SERIE F MANHA</option>
            <option value="1ª SERIE G TARDE">1ª SERIE G TARDE</option>
            <option value="1ª SERIE H NOITE">1ª SERIE H NOITE</option>
            <option value="1ª SERIE I NOITE">1ª SERIE I NOITE</option>
            <option value="2ª SERIE A MANHA">2ª SERIE A MANHA</option>
            <option value="2ª SERIE B MANHA">2ª SERIE B MANHA</option>
            <option value="2ª SERIE C MANHA">2ª SERIE C MANHA</option>
            <option value="2ª SERIE D MANHA">2ª SERIE D MANHA</option>
            <option value="2ª SERIE E MANHA">2ª SERIE E MANHA</option>
            <option value="2ª SERIE F NOITE">2ª SERIE F NOITE</option>
            <option value="2ª SERIE G NOITE">2ª SERIE G NOITE</option>
            <option value="2ª SERIE H NOITE">2ª SERIE H NOITE</option>
            <option value="2ª SERIE I NOITE">2ª SERie I NOITE</option>
            <option value="3ª SERIE A MANHA">3ª SERIE A MANHA</option>
            <option value="3ª SERIE B MANHA">3ª SERIE B MANHA</option>
            <option value="3ª SERIE C MANHA">3ª SERIE C MANHA</option>
            <option value="3ª SERIE D NOITE">3ª SERIE D NOITE</option>
            <option value="3ª SERIE E NOITE">3ª SERIE E NOITE</option>
            <option value="3ª SERIE F NOITE">3ª SERIE F NOITE</option>
            <option value="3ª SERIE G NOITE">3ª SERIE G NOITE</option>
            <option value="4050 - ADMINISTRAÇÃO - 2ª SERIE A MANHA">4050 - ADMINISTRAÇÃO - 2ª SERIE A MANHA</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>SALA:</label>
          <input type="text" id="sala" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>AULA(S):</label>
          <div id="aula-container" class="aula-container">
            <!-- Checkboxes para aulas serão inseridos aqui -->
          </div>
        </div>
      </div>

      <div class="conflict-message" id="conflictMessage">
        <i class="fas fa-exclamation-circle"></i> Já existe um agendamento para este local/horário!
      </div>

      <div class="buttons-container">
        <button class="btn btn-cadastrar" onclick="agendarEquipamento()">
          <i class="fas fa-calendar-check"></i> AGENDAR
        </button>
        <button class="btn btn-limpar" onclick="limparFormulario()">
          <i class="fas fa-broom"></i> LIMPAR
        </button>
      </div>
    </div>

    <div class="calendar-container">
      <div class="export-buttons">
        <button class="btn btn-cadastrar" onclick="exportarParaPDF()">
          <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
        <button class="btn btn-cadastrar" onclick="exportarParaCSV()">
          <i class="fas fa-file-csv"></i> Exportar CSV
        </button>
      </div>
      
      <div style="margin-bottom: 20px; display: flex; gap: 15px;">
        <select id="monthSelect" style="flex: 1; padding: 10px; border-radius: 8px; border: 2px solid #ddd; background-color: var(--cinza-input);"></select>
        <select id="yearSelect" style="flex: 1; padding: 10px; border-radius: 8px; border: 2px solid #ddd; background-color: var(--cinza-input);"></select>
      </div>

      <table class="calendar">
        <thead>
          <tr>
            <th>Dom</th>
            <th>Seg</th>
            <th>Ter</th>
            <th>Qua</th>
            <th>Qui</th>
            <th>Sex</th>
            <th>Sáb</th>
          </tr>
        </thead>
        <tbody id="calendarBody">
          <!-- Dias serão inseridos via JavaScript -->
        </tbody>
      </table>

      <h3>HISTÓRICO DE AGENDAMENTOS</h3>
      <table class="historico-table">
        <thead>
          <tr>
            <th>DATA</th>
            <th>TURMA</th>
            <th>N° APARELHOS</th>
            <th>APARELHO</th>
            <th>PROFESSOR</th>
            <th>AULA(s)</th>
            <th>ENTREGA</th>
            <th>AÇÃO</th>
          </tr>
        </thead>
        <tbody id="historico-body">
          <!-- Histórico dinâmico -->
        </tbody>
      </table>
    </div>
  </div>

  <div id="devolucaoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h3>Finalizar Agendamento</h3>
      <p id="modalText"></p>
      <div class="form-group">
        <label for="horaEntregaModal">Hora da Entrega:</label>
        <input type="time" id="horaEntregaModal" value="" style="background-color: var(--cinza-input);">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-limpar" onclick="fecharModal()">Cancelar</button>
        <button class="btn btn-entregar" onclick="finalizarAgendamento()">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBOoXyjLQPfgzQM06LVy-TRSPdSM_8CjcE",
      authDomain: "gerenciamentoaparelho.firebaseapp.com",
      projectId: "gerenciamentoaparelho",
      storageBucket: "gerenciamentoaparelho.appspot.com",
      messagingSenderId: "751628186418",
      appId: "1:751628186418:web:dd68af74d9e3723c179d2b",
      measurementId: "G-K02ZZQ4JBK"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Referências às coleções
    const agendamentosRef = db.collection("agendamentos");
    const historicoExcluidosRef = db.collection("historico_excluidos");

    // Inicializa o jsPDF
    const { jsPDF } = window.jspdf;
    
    // Dados dos professores
    const teacherEmails = {
      "ADEMAR RIBEIRO DE SOUZA": "ademarribeirosouza@prof.educacao.sp.gov.br",
      "ALEX LUTH PEREIRA MARANHAO": "luth@prof.educacao.sp.gov.br",
      "ALEXANDRE SILVA LIMA": "alexandresilvalima@prof.educacao.sp.gov.br",
      "ALEXSANDRA PAULA VARELLA DE SOUZA": "avarella@prof.educacao.sp.gov.br",
      "ALINE CARDOSO": "aline.cardoso@servidor.educacao.sp.gov.br",
      "ALISON VASCONCELOS BESERRA": "alisonv@prof.educacao.sp.gov.br",
      "AMAURI TEODORO DE OLIVEIRA": "amaurit@prof.educacao.sp.gov.br",
      "ANA PAULA DE OLIVEIRA SOUZA": "ana.souza59@servidor.educacao.sp.gov.br",
      "ANA PAULA DOS SANTOS": "paulasantosa@prof.educacao.sp.gov.br",
      "ANDRE LUIZ TAVARES": "andreltavares@prof.educacao.sp.gov.br",
      "ANDREIA DOS SANTOS FREITAS": "sanfreitas@prof.educacao.sp.gov.br",
      "ANDREIA MADUREIRA REIS": "andreiamadureira@prof.educacao.sp.gov.br",
      "ANTONIO CARLS DE OLIVEIRA": "antoniocarloso@prof.educacao.sp.gov.br",
      "ANTONIO RAMOS DE ARAUJO": "antonioramosaraujo@prof.educacao.sp.gov.br",
      "ANTONIO WILTON WANDERLEY CABRAL": "antoniowilton@prof.educacao.sp.gov.br",
      "AUGUSTO LINO PESSOA NETO": "augustolino@prof.educacao.sp.gov.br",
      "AUREA MARIA DE JESUS MARQUES": "aureamaria@prof.educacao.sp.gov.br",
      "CAROLINA PERNOMIAN PARUSSOLO": "carolinapernomian@prof.educacao.sp.gov.br",
      "CASSIA OLIVEIRA ANTONIAZI": "cassiaosilva@prof.educacao.sp.gov.br",
      "CICERO FERREIRA": "cicero.ferreira@servidor.educacao.sp.gov.br",
      "DANIEL DE FREITAS ALMEIDA": "danielalmeida@prof.educacao.sp.gov.br",
      "DANIEL LOPES BARBOSA": "daniellopesbarbosa@prof.educacao.sp.gov.br",
      "DANIELA FERREIRA LIMA": "danielaflima@prof.educacao.sp.gov.br",
      "EDIANE VIEIRA DA SILVA": "ediane@prof.educacao.sp.gov.br",
      "EDILEUSA NUNES PEREIRA": "edileusa@prof.educacao.sp.gov.br",
      "EDUARDO HENRIQUE DA FONSECA": "henriquefonseca@prof.educacao.sp.gov.br",
      "ELIANE SANTOS SILVA": "essantos@prof.educacao.sp.gov.br",
      "ELIAS MONTEIRO DA SILVA": "elias1@prof.educacao.sp.gov.br",
      "ELISABETE APARECIDA PIRES": "elisabetepires@prof.educacao.sp.gov.br",
      "ELZA DE FARIA PEREIRA": "elzafariapereira@prof.educacao.sp.gov.br",
      "EMERSON GABLER DE ALMEIDA": "egabler@prof.educacao.sp.gov.br",
      "ERINEIDE LEITE ARAGAO NERY": "erineidearagao@prof.educacao.sp.gov.br",
      "EUZELI ARAUJO DE OLIVEIRA": "euzeli@prof.educacao.sp.gov.br",
      "FABIANO AUGUSTO PIEDADE": "fabianoaugusto@prof.educacao.sp.gov.br",
      "FABIO CAMILO": "camilof@prof.educacao.sp.gov.br",
      "FERNANDO JOSE DA SILVA FILHO": "fernandojs@prof.educacao.sp.gov.br",
      "FLAVIA CRISTINA APARECIDA BICHLER": "flaviacri@prof.educacao.sp.gov.br",
      "FLAVIO CARDOSO FLEURY": "flaviofleury@prof.educacao.sp.gov.br",
      "GABRIELA SERIGHELLI DE MELO": "gabrielaserighelli@prof.educacao.sp.gov.br",
      "GELSON DE ALMEIDA BATISTA": "gelsonalmeida@prof.educacao.sp.gov.br",
      "GENILTON DE OLIVEIRA SILVA": "genilton@prof.educacao.sp.gov.br",
      "GIANI CRISTINA DO PRADO": "gianiprado@prof.educacao.sp.gov.br",
      "INGRYD CAROLINA SUGUIMOTO VIEIRA": "ingryd@prof.educacao.sp.gov.br",
      "IVANILDES DOS SANTOS OSHIKAWA": "oshikawa@prof.educacao.sp.gov.br",
      "JANINA DOS PASSOS BRAGA DE ALMEIDA": "janinabraga@prof.educacao.sp.gov.br",
      "JUAREZ GOMES DE MAGALHAES FILHO": "juarezgomes@prof.educacao.sp.gov.br",
      "JUREMA SOLEDADE FURINI SANTOS": "juremas@prof.educacao.sp.gov.br",
      "KATIUSCIA ALVES BOMFIM": "katiusciabomfim@prof.educacao.sp.gov.br",
      "KETHY REGINA DA SILVA DOMINGOS COSTA": "kethy@prof.educacao.sp.gov.br",
      "LUANA CAROLINE ALVES LIMA": "luanalima01@prof.educacao.sp.gov.br",
      "LUANA DE FREITAS SILVA": "luanafreitas@prof.educacao.sp.gov.br",
      "LUCIANA NOVAIS CORREIA SANTOS": "novaiscorreia@prof.educacao.sp.gov.br",
      "LUCIANO MOREIRA DE AZEVEDO": "lucianomoreira@prof.educacao.sp.gov.br",
      "MARCELO FERNANDES DA SILVA": "marcelofs@prof.educacao.sp.gov.br",
      "MARCIEL DA SILVA": "marcielsilva@prof.educacao.sp.gov.br",
      "MARIA HELENA CUNHA MORO": "marcunha@prof.educacao.sp.gov.br",
      "MARIA QUITÉRIA FERREIRA DOS SANTOS": "quiteriasantos@prof.educacao.sp.gov.br",
      "MARINA DA CONCEICAO FRANCISCO SILVA": "marinafrancisco@prof.educacao.sp.gov.br",
      "MAURICIO DE BARROS SANTOS": "mauriciobsantos@prof.educacao.sp.gov.br",
      "MICHELE DE PINHO MORAES": "michelepinho@prof.educacao.sp.gov.br",
      "MOISES ANTONIO DE BARROS": "moisesbarros@prof.educacao.sp.gov.br",
      "PATRICIA GOMES ROCHA RIBEIRO": "patriciag@prof.educacao.sp.gov.br",
      "PAULO ROBERTO DA SILVA ITO": "pauloito@prof.educacao.sp.gov.br",
      "PEDRO ZANOTTI FILHO": "pedrozanotti@prof.educacao.sp.gov.br",
      "RAUL PEREIRA VILERA JUNIOR": "vilera@prof.educacao.sp.gov.br",
      "REGIANE CURTI DE SOUZA OLIVEIRA": "regianecurti@prof.educacao.sp.gov.br",
      "REGINA DA SILVA CASTRO": "reginasilvacastro@prof.educacao.sp.gov.br",
      "RICARDO AMERICO DA SILVA": "ricardoamerico@prof.educacao.sp.gov.br",
      "ROBERTO SALGADO": "robertosalgado@prof.educacao.sp.gov.br",
      "RODRIGO VIEIRA": "rodrigovieira1@prof.educacao.sp.gov.br",
      "ROSANGELA CAFASSO MOREIRA": "cafasso@prof.educacao.sp.gov.br",
      "ROSIMERY DE SOUZA PESSOA": "rosimerypessoa@prof.educacao.sp.gov.br",
      "ROSMARA DA SILVA CARDOSO": "rosmaracardoso@prof.educacao.sp.gov.br",
      "SANDRA CRISTINA MACEDO MORAES": "sandracristinamacedo@prof.educacao.sp.gov.br",
      "SELMA GOMES DA SILVA": "selmagomess@prof.educacao.sp.gov.br",
      "SERGIO AGRIPINO VILLA NOVA": "sergioagripino@prof.educacao.sp.gov.br",
      "SOLANGE ALMEIDA DA SILVA": "almeidafazio@prof.educacao.sp.gov.br",
      "SUELI SILVE PEREIRA": "suelisilve@prof.educacao.sp.gov.br",
      "SUZINEIDE SILVA DE FREITAS": "suzineidefreitas@prof.educacao.sp.gov.br",
      "THIAGO FABIANO BRITO": "thiagofabiano@prof.educacao.sp.gov.br",
      "TITTO AUGUSTO NASCIMENTO SILVA": "titto@prof.educacao.sp.gov.br",
      "VANDERSON HYPPOLITO": "vhypolito@prof.educacao.sp.gov.br",
      "VANESSA IVETE GOMES DOS SANTOS": "vanessaivete@prof.educacao.sp.gov.br",
      "VANIA PENHA DE BARROS": "vaniapenha@prof.educacao.sp.gov.br",
      "VIVIANE LEAL CAMERA DE MORAES": "camera@prof.educacao.sp.gov.br",
      "WILSON LUIZ DE SOUZA COSTA": "wilsonluizsouza@prof.educacao.sp.gov.br",
      "WILSON RODRIGUES MOTA": "wmota@prof.educacao.sp.gov.br"
    };

    // Dados dos aparelhos
    const marcas = {
      "TABLET": "POSITIVO",
      "SMARTPHONE": "POSITIVO",
      "CHROMEBOOK": "SAMSUNG",
      "NOTEBOOK": "POSITIVO"
    };

    // Dados das salas por turma e período
    const salasPorTurmaPeriodo = {
      "6° ANO A MANHA": "Sala 1",
      "6° ANO B MANHA": "Sala 2",
      "6° ANO C MANHA": "Sala 3",
      "6° ANO D MANHA": "Sala 4",
      "6° ANO E TARDE": "Sala 1",
      "6° ANO F TARDE": "Sala 2",
      "7° ANO A TARDE": "Sala 3",
      "7° ANO B TARDE": "Sala 4",
      "7° ANO C TARDE": "Sala 5",
      "7° ANO D TARDE": "Sala 6",
      "7° ANO E TARDE": "Sala 7",
      "7° ANO F TARDE": "Sala 8",
      "8° ANO A TARDE": "Sala 10",
      "8° ANO B TARDE": "Sala 11",
      "8° ANO C TARDE": "Sala 12",
      "8° ANO D TARDE": "Sala 13",
      "8° ANO E TARDE": "Sala 14",
      "9° ANO A TARDE": "Sala 15",
      "9° ANO B TARDE": "Sala 16",
      "9° ANO C TARDE": "Sala 17",
      "9° ANO D TARDE": "Sala 18",
      "1ª SERIE A MANHA": "Sala 10",
      "1ª SERIE B MANHA": "Sala 11",
      "1ª SERIE C MANHA": "Sala 12",
      "1ª SERIE D MANHA": "Sala 13",
      "1ª SERIE E MANHA": "Sala 14",
      "1ª SERIE F MANHA": "Sala 15",
      "1ª SERIE G TARDE": "Sala 9",
      "1ª SERIE H NOITE": "Sala 9",
      "1ª SERIE I NOITE": "Sala 602",
      "2ª SERIE A MANHA": "Sala 5",
      "2ª SERIE B MANHA": "Sala 6",
      "2ª SERIE C MANHA": "Sala 7",
      "2ª SERIE D MANHA": "Sala 8",
      "2ª SERIE E MANHA": "Sala 9",
      "2ª SERIE F NOITE": "Sala 1",
      "2ª SERIE G NOITE": "Sala 2",
      "2ª SERIE H NOITE": "Sala 3",
      "2ª SERIE I NOITE": "Sala 4",
      "3ª SERIE A MANHA": "Sala 16",
      "3ª SERIE B MANHA": "Sala 17",
      "3ª SERIE C MANHA": "Sala 18",
      "3ª SERIE D NOITE": "Sala 5",
      "3ª SERIE E NOITE": "Sala 6",
      "3ª SERIE F NOITE": "Sala 7",
      "3ª SERIE G NOITE": "Sala 8",
      "4050 - ADMINISTRAÇÃO - 2ª SERIE A MANHA": "Laboratório 1"
    };

    // Horários dos professores (dados fornecidos)
    const horariosProfessores = {
      "ADEMAR": { 
        "MANHA": ["1D", "1E", "1E", "1F", "1F", "1B", "1B", "1A", "1A", "1D", "1C", "1C"], 
        "TARDE": ["9C", "9B", "9B", "1G", "1G", "9A", "9A", "9C", "9C", "9D", "9A", "9D"], 
        "NOITE": ["2F", "2G", "2G", "2H", "2F", "2H", "1H", "1H", "2F", "2G", "2G", "2H"] 
      }, 
      "ALISSON": { 
        "MANHA": ["6A", "6D", "6B", "1F", "6A", "6A", "1D", "6C", "1B", "1B/BIO", "3C/PV", "6C/CIÉ", "1E/BIO", "6B", "6B", "1C", "6C", "1F", "6D", "1E", "1A", "1A", "1C", "6D/C", "1D"], 
        "TARDE": ["8A", "8A", "7D/PV", "7C/PV", "8A", "8A", "7E/PV", "7C/PV", "8A", "8A", "7E/PV", "7C/PV"], 
        "NOITE": [] 
      }, 
      "ANDRÉIA": { 
        "MANHA": ["1E", "1F", "1D", "2C", "1C", "2D", "1F/R", "1D", "1F", "1E", "1C", "1F/R", "2C/R", "1D", "1C", "1C", "1E", "1C/R", "1D/R", "1E", "1B/R", "1E/R", "1D/R", "1F", "2D/R", "1E", "1C", "1F", "1D", "1B/R"], 
        "TARDE": [], 
        "NOITE": [] 
      }, 
      "ANTONIO CARLOS": { 
        "MANHA": ["2B", "2B", "2E", "2E", "2C", "2C", "2D", "2D", "2A", "2D", "2D", "2E", "2E", "2A", "2A", "2C", "2C", "2A", "2B", "2B"], 
        "TARDE": [], 
        "NOITE": ["3G", "2F", "2F", "2G", "2G"] 
      }, 
      "BETE": { 
        "MANHA": ["1A", "1A", "1A", "1E", "1B", "1B", "1E/EF", "1E/EF", "1D", "1D", "1B", "1A", "1C/EF", "1C/EF", "1E", "1E", "1D/EF", "1D/EF", "1C", "1C", "1E", "1B", "1A/EF", "1A/EF", "1B/EF", "1B/EF", "1D", "1D", "1C", "1C"],
        "TARDE": ["1G", "1G"],
        "NOITE": []
      },
      "DANIEL": {
        "MANHA": ["6C", "6C", "2C", "6D", "3C", "3C", "2ADM/H", "2ADM/H", "6A", "2C", "2D/L", "2D/L", "6B", "6B", "2A", "2A", "2B", "2B", "2D", "2D", "6D", "6A", "3B", "3B", "3A", "3A", "2C/L", "2C/L", "2E", "2E"],
        "TARDE": ["6E", "6E"],
        "NOITE": [] 
      },
      "DANIELA": {
        "MANHA": ["1C", "1C", "6A", "6A", "6D", "6D", "6B", "6B", "6C", "6C", "1D", "1D", "1A", "1A", "1F", "1F", "1B", "1B", "1E", "1E"],
        "TARDE": ["7D", "7C", "9A", "7E", "7E", "7C", "7D", "7B", "7B", "7A", "1G", "1G", "9D", "7A", "7D", "7B", "7B", "7A", "1G", "1G"],
        "NOITE": ["1H"] 
      },
      "EDIANE": {
        "MANHA": ["2ADM", "2ADM", "2ADM"],
        "TARDE": ["6E/R", "7C", "6F", "6F", "7B", "6F", "7C", "7B", "6F/R", "6F/R", "9C/O", "9D/O", "6F", "7D", "9D/OP", "7D", "7C", "7D", "7B", "7D", "7C", "9B/OP", "6E/R", "9B/OP", "9C/OP", "7B", "6F", "6F", "7C"],
        "NOITE": ["2G", "2F", "2F", "3E/OP", "3E/OP", "2H", "2H", "2H", "2F", "2F", "3F", "3F", "2G", "2G", "2G", "3G/OP", "3G/OP", "3D/OP", "3D/OP"]
      },
      "ELIAS": {
        "MANHA": ["2E", "2E", "3B", "3B", "2C", "2C", "1C", "1C", "2ADM/Q", "2ADM/Q", "3A", "3A", "2B", "2B", "1A", "1A", "2A", "1F", "1B", "1B", "3C", "3C", "1E", "1E", "1D", "1D", "1F", "2A", "2D", "2D"],
        "TARDE": ["1G", "1G", "9C", "9C", "9B", "9B/OM", "9A", "8E/PV", "9A", "8D/PV"],
        "NOITE": ["1H/Q", "1H/Q", "1H/EF", "1H/EF", "1H/F", "1H/F"]
      },
      "JANINA": {
        "MANHA": ["2ADM/B", "2ADM/B", "2B", "2A", "2A", "2B", "3C/BIOT", "3C/BIOT", "2C", "2C", "3A", "3A", "3B", "3B", "2E", "2D", "2D", "2E"],
        "TARDE": ["9B", "9C", "9B", "9C", "9D", "9B", "9A", "9A"],
        "NOITE": ["3D", "3F", "3D", "3E", "3E", "3F"]
      },
      "JUAREZ": {
        "MANHA": ["1E", "1E", "1F", "3A", "3A", "3C", "3C", "1F", "1D", "1D", "3B", "3B", "1E", "1E", "1F"],
        "TARDE": [],
        "NOITE": ["2F/FÍS", "2G", "2G", "1J", "1J", "2H", "2H", "3F", "3E", "3E", "2F/FÍS", "2G", "2G", "1J", "1J", "2H/Q", "3D", "3D", "2G", "2G"]
      },
      "MOISÉS": {
        "MANHA": [],
        "TARDE": [],
        "NOITE": ["3E/OM", "3G", "3G", "3F/OM", "3F/OM", "3E", "3E", "3G", "3G", "3D", "3G/OM", "3D/OM", "3D/OM", "3F", "3F"]
      },
      "PEDRO": {
        "MANHA": [],
        "TARDE": ["6F", "6F"],
        "NOITE": ["3F", "3G", "3E", "3G", "1I", "1I", "3F", "3E"]
      },
      "RODRIGO": {
        "MANHA": ["1D", "1D", "1C", "1C", "1F", "1F", "1B", "1B", "1A", "1A", "1E", "1E", "3D", "3G", "3E"],
        "TARDE": [],
        "NOITE": ["3D", "3G", "3E", "3D", "2G", "2F", "1I", "1I", "3F", "2G", "1I"]
      },
      "VIVIANE": {
        "MANHA": ["6B", "1B", "6B", "3A", "1D", "6C", "1F", "1E", "1B", "6C", "1C", "1D", "6D", "6A", "1F", "1C", "3A", "6A", "6D", "1E", "6A", "6D"],
        "TARDE": ["7E/R", "6E/T", "7E/R", "7A/T", "6E/T", "7D/T", "7E/T", "7C/T", "7A/R", "7A/R", "7C/T", "7B/T", "7B/T", "8B/PV", "9D/PV", "7D/T", "7F/T", "7F/T", "7E", "7E/T", "7C/T", "7A/R", "7A/R", "7C/T", "7B/T"],
        "NOITE": ["1H/R", "1H/P", "1H/P", "1H/R", "1H/P", "1H/P"]
      },
      "KATIUSCIA": {
        "MANHA": ["1A", "1A"],
        "TARDE": ["8A", "9C", "8B", "8C", "8E", "8E", "7C", "7A", "7A", "7D", "7D", "8B", "9D", "9D", "9A", "9A", "7E", "7E", "8C", "7F", "7F", "8D", "8D", "7C"],
        "NOITE": [] 
      },
      "MARINA": {
        "MANHA": ["6B", "6A", "6B/EF", "6B/EF", "6D", "6D", "6D", "6B", "6A", "6B", "6C", "6C", "6B", "6A/EF", "6A/EF", "6D", "6D", "6A", "6D/EF", "6D/EF", "6A", "6C", "6C", "6A", "6B", "6C/EF", "6C/EF"],
        "TARDE": ["6F", "6F", "6E", "6E", "7A", "7B/EF", "7B/EF", "7A", "7A/EF", "7A/EF"],
        "NOITE": [] 
      },
      "NILDES": {
        "MANHA": ["3C", "2C", "2D", "3A", "2D", "3A", "2B", "3A/OM", "3B", "3B", "2C", "2C", "3B", "2C", "3C", "2D", "3A/O M", "3B", "2E", "2E", "2B", "2B", "2B", "2A", "2E", "2B", "2E", "3C", "2D", "3A", "3C"],
        "TARDE": ["8A", "8A"],
        "NOITE": []
      },
      "ROSANGELA": {
        "MANHA": ["1B", "1B", "2A", "2A", "2E", "2E", "1A", "1A", "1C", "1C", "2B", "2B", "2A/PR", "2A/PR", "3A/PR", "3A/PR", "2C/Q", "2C/Q", "3B/EM", "3B/EM", "2D/QU", "2D/QU", "2B/PR", "2B/PR", "3B/P", "3B/P", "3A/EM", "3C/P", "3C/P", "3A/EM"],
        "TARDE": ["1G", "1G"],
        "NOITE": []
      },
      "SÉRGIO": {
        "MANHA": ["2A", "3B", "3A", "2B", "2A", "3B", "3A", "2B"],
        "TARDE": ["9D", "9D", "7C", "7C", "8D", "8D", "9B", "9B", "9C", "9C", "9A", "9A"],
        "NOITE": ["2F", "3D", "3E", "3F", "2F", "1J", "3D", "2G", "3E", "2H", "3G"]
      },
      "TITO": {
        "MANHA": ["6D"],
        "TARDE": ["7A", "7F", "7F", "7A", "7B", "7B", "6F", "6F", "6E", "6E", "7E", "7E"],
        "NOITE": []
      },
      "VANDERSON": {
        "MANHA": ["3A", "3A", "3C", "3C", "3B", "3C", "3C", "3A", "3A"],
        "TARDE": [],
        "NOITE": []
      },
      "FLÁVIA": {
        "MANHA": ["X", "X", "X", "X", "X", "X"],
        "TARDE": [],
        "NOITE": []
      },
      "CAROL": {
        "MANHA": [],
        "TARDE": ["1G", "1G", "7A", "7A", "9D", "9D", "9A", "7B", "7B", "9B", "9B", "9C", "9D"],
        "NOITE": []
      },
      "CASSIA": {
        "MANHA": [],
        "TARDE": ["8C", "8E", "8E", "8B", "8B", "8B", "8D", "8D", "8B", "8C", "8D", "8D", "8E", "8E", "8C", "8C"],
        "NOITE": []
      },
      "DANIEL FREITAS": {
        "MANHA": [],
        "TARDE": ["9B", "9B", "9D", "1G", "1G", "9A", "9B", "8E/EF", "8E/EF", "9C", "9A", "9D", "9D", "9B", "9B", "9A", "9C", "9C", "9D", "9D"],
        "NOITE": ["11H", "11H"]
      },
      "GUSTAVO": {
        "MANHA": [],
        "TARDE": ["7F/AR", "9C/AR", "7F/AR"],
        "NOITE": ["11"]
      },
      "GELSON": {
        "MANHA": ["2D/EF", "2D/EF", "3C/OM", "3C/OM", "3B/OM", "3B/OM"],
        "TARDE": ["8B", "8A", "8A", "8B", "8B", "8A", "8A", "8B"],
        "NOITE": []
      },
      "LUANA": {
        "MANHA": ["6D", "6B", "6A"],
        "TARDE": ["9C", "7A", "7A", "9A", "9B", "9B", "9C", "9C", "1G", "1G", "9D", "9D", "9A", "9B", "9B", "9C", "1G", "1G"],
        "NOITE": []
      },
      "LUCIANO": {
        "MANHA": [],
        "TARDE": ["8A", "8A", "8D", "9A", "9C", "7E", "8B", "9C", "7E", "7F", "7F", "8C", "7E", "9B", "7F", "9D", "8D", "9A", "8E", "8E"],
        "NOITE": []
      },
      "MARA": {
        "MANHA": [],
        "TARDE": ["1G", "9A", "9D", "8A", "8E", "8D", "8C", "9C", "9C", "9D", "8D", "9A", "8C", "9B", "9B", "8A/PV", "8E", "8A", "1G"],
        "NOITE": []
      },
      "MARCIEL": {
        "MANHA": [],
        "TARDE": ["7E", "7E", "7B", "9B/PV", "8C", "8C", "9A/PV", "8E", "8E", "8A", "7C", "7D", "8C", "7D", "7F", "7F", "8D", "8D", "8A", "8A", "8B", "7C", "7A", "7A"],
        "NOITE": ["3D", "3D"]
      },
      "REGINA": {
        "MANHA": ["1A", "1A"],
        "TARDE": ["9D", "9D", "7C", "7C", "8D", "8D", "9B", "9B", "9C", "9C", "9A", "9A", "7D", "7B", "7B", "8B", "8A", "7D/R", "6E", "6E", "8A/R", "8C/R", "8C/R"],
        "NOITE": []
      },
      "ROSE": {
        "MANHA": ["6C", "1B", "6B", "6A", "1A", "6C", "6D", "6A", "6D", "1B", "6B", "1A", "6B", "6C", "1A", "1B", "6D"],
        "TARDE": [],
        "NOITE": []
      },
      "SELMA": {
        "MANHA": ["1A", "1D", "1C", "1B", "1G/F", "1A", "1C", "1B", "1D"],
        "TARDE": [],
        "NOITE": []
      },
      "SUZY": {
        "MANha": ["2ADM", "2ADM", "2B", "2B", "2E", "2E"],
        "TARDE": ["6F", "6F", "6E", "1G", "1G"],
        "NOITE": ["1H", "2F", "2G", "1I", "2H"]
      },
      "VANIA": {
        "MANHA": ["3C", "3C"],
        "TARDE": ["8D", "8C", "8C", "8A", "8A", "7E", "8B", "8B", "7F", "7E", "7E", "8A", "8E", "8B", "8B", "8D", "8D", "8E", "7F", "7F", "8A", "7E", "9A/OP", "9A/OP"],
        "NOITE": []
      },
      "WILSON": {
        "MANHA": [],
        "TARDE": ["6E", "8C", "6E", "6F", "8D", "8A", "6F", "8E", "8B"],
        "NOITE": []
      },
      "WILTON": {
        "MANHA": [],
        "TARDE": ["7D/EF", "8A/T", "8E/T", "8C/EF", "8D/EF", "8D/EF", "8B/T", "8C/T", "8D/T", "8C/EF", "8D/T", "7C/EF", "7D/EF", "7C/EF", "8B/EF", "8A/T", "8E/T", "8B/EF"],
        "NOITE": []
      },
      "SOL": {
        "MANHA": [],
        "TARDE": ["X", "X", "X", "X", "X", "X"],
        "NOITE": []
      },
      "ELIANE CONTI": {
        "MANHA": ["3C/EMP"],
        "TARDE": [],
        "NOITE": []
      },
      "EDIVÂNIA": {
        "MANHA": ["1F", "1F", "2B/EMP", "1F", "2E/EF", "1F", "2E/EF"],
        "TARDE": ["7F", "7E", "7E", "7F"],
        "NOITE": []
      },
      "ELIANE SANTOS": {
        "MANHA": ["2D", "2D", "6D", "6C/PV", "2ADM/G", "2ADM/G", "6A", "3B/PV", "6B/PV", "6A/PV", "6B", "6D", "6C", "6C", "6B", "3A/PV"],
        "TARDE": ["1G", "1G"],
        "NOITE": []
      },
      "EUZELI": {
        "MANHA": ["3B", "1E", "1E", "2D", "2B", "1B", "1B", "1D", "1D", "1F", "1C", "1C", "2E", "3A", "1F", "2ADM", "2C", "2A"],
        "TARDE": [],
        "NOITE": []
      },
      "MAURÍCIO": {
        "MANHA": ["2C/EF", "2A/EF", "2ADM/M.A", "2ADM/M.A", "2A/MAT", "2C/EF", "2B/EF", "2ADM/M", "2ADM/M", "2A", "2A", "2ADM", "2ADM", "2ADM", "2B"],
        "TARDE": [],
        "NOITE": []
      },
      "PAULO": {
        "MANHA": ["2E", "2E", "2E/L", "2E/L", "1F/FIL", "1F/FIL", "2D/OR", "2D/SOC", "2D/SOC", "2B", "2B", "2C/OR", "2E/OR", "2C", "2C", "2ADM", "2ADM", "1E/F", "1E/F", "2A/S", "2A/S"],
        "TARDE": ["6E", "6F", "8C"],
        "NOITE": ["2H", "2G", "2F"]
      },
      "REGIANE": {
        "MANHA": ["3B", "3B", "3A", "3A"],
        "TARDE": [],
        "NOITE": []
      },
      "RICARDO": {
        "MANHA": [],
        "TARDE": [],
        "NOITE": []
      },
      "SANDRA": {
        "MANHA": [],
        "TARDE": [],
        "NOITE": ["1H/F", "1H/G", "1H/G"]
      }
    };

    const monthNames = [
      "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
    ];

    const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    let selectedDay = null;
    let selectedDate = null;
    let currentPopupDate = new Date();
    let popupSelectedDate = null;
    let agendamentoParaDevolver = null;
    let agendamentos = {};
    let historicoExcluidos = [];
    let aulasDisponiveis = [];

    // Função para remover acentos
    function removerAcentos(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    // Funções do Firebase
    async function carregarDadosIniciais() {
      try {
        // Carrega agendamentos
        const snapshotAgendamentos = await agendamentosRef.get();
        agendamentos = {};
        snapshotAgendamentos.forEach(doc => {
          const data = doc.data();
          const mesAno = data.mesAno;
          if (!agendamentos[mesAno]) {
            agendamentos[mesAno] = [];
          }
          agendamentos[mesAno].push({ id: doc.id, ...data });
        });
        
        // Carrega histórico excluído
        const snapshotHistorico = await historicoExcluidosRef.get();
        historicoExcluidos = [];
        snapshotHistorico.forEach(doc => {
          historicoExcluidos.push(doc.data());
        });
        
        // Renderiza o calendário
        renderCalendarBody(Number(yearSelect.value), Number(monthSelect.value));
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
      }
    }

    async function salvarAgendamentoFirestore(agendamento) {
      try {
        const docRef = await agendamentosRef.add(agendamento);
        return docRef.id;
      } catch (error) {
        console.error("Erro ao salvar agendamento:", error);
        return false;
      }
    }

    async function atualizarAgendamentoFirestore(id, dados) {
      try {
        await agendamentosRef.doc(id).update(dados);
        return true;
      } catch (error) {
        console.error("Erro ao atualizar agendamento:", error);
        return false;
      }
    }

    async function excluirAgendamentoFirestore(id, agendamento) {
      try {
        // Adiciona ao histórico
        await historicoExcluidosRef.add({
          ...agendamento,
          dataExclusao: new Date().toISOString()
        });
        
        // Exclui o agendamento
        await agendamentosRef.doc(id).delete();
        return true;
      } catch (error) {
        console.error("Erro ao excluir agendamento:", error);
        return false;
      }
    }

    // Funções do sistema
    function estaDentroDoPeriodo(dataAgendamento) {
      const hoje = new Date();
      const dataAgendamentoObj = new Date(dataAgendamento);
      const diferencaDias = Math.floor((hoje - dataAgendamentoObj) / (1000 * 60 * 60 * 24));
      return diferencaDias <= 15;
    }

    function formatarDataParaComparacao(dia, mes, ano) {
      return `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
    }

    async function verificarConflitoAgendamento(turma, data, aula) {
      const [dia, mes, ano] = data.split('/');
      const mesAno = `${ano}-${mes}`;
      
      try {
        const querySnapshot = await agendamentosRef
          .where("mesAno", "==", mesAno)
          .where("dia", "==", parseInt(dia))
          .where("turma", "==", turma)
          .where("aula", "==", aula)
          .get();
          
        return !querySnapshot.empty;
      } catch (error) {
        console.error("Erro ao verificar conflito:", error);
        return false;
      }
    }

    function atualizarMarca() {
      const tipo = document.getElementById("equipamentoAgendamento").value;
      document.getElementById("marca").value = marcas[tipo] || "";
    }

    function atualizarSala() {
      const turma = document.getElementById("studentClass").value;
      document.getElementById("sala").value = salasPorTurmaPeriodo[turma] || "Sala não definida";
    }

    function atualizarEmail() {
      const nome = document.getElementById("professor").value;
      document.getElementById("email-professor").value = teacherEmails[nome] || "";
    }

    function atualizarEmailEAulas() {
      atualizarEmail();
      atualizarAulasDisponiveis();
    }

    function atualizarSalaEAulas() {
      atualizarSala();
      atualizarAulasDisponiveis();
    }

    function gerarOpcoesProfessores() {
      const select = document.getElementById("professor");
      Object.keys(teacherEmails).forEach(nome => {
        const option = document.createElement("option");
        option.value = nome;
        option.textContent = nome;
        select.appendChild(option);
      });
    }

    function obterPeriodoTurma(turma) {
      if (turma.includes("MANHA")) return "MANHA";
      if (turma.includes("TARDE")) return "TARDE";
      if (turma.includes("NOITE")) return "NOITE";
      return "";
    }

    function obterAulasProfessor(professor, periodo) {
      const nomeFormatado = removerAcentos(professor.split(' ')[0]).toUpperCase();
      if (!horariosProfessores[nomeFormatado]) return [];
      return horariosProfessores[nomeFormatado][periodo] || [];
    }

    function atualizarAulasDisponiveis() {
      const professor = document.getElementById("professor").value;
      const turma = document.getElementById("studentClass").value;
      const data = document.getElementById("dataAgendamento").value;
      const aulaContainer = document.getElementById("aula-container");
      
      aulaContainer.innerHTML = '';
      aulasDisponiveis = [];
      
      if (!professor || professor === "Selecione" || !turma || !data) {
        return;
      }
      
      const periodo = obterPeriodoTurma(turma);
      if (!periodo) return;
      
      // Corrigido: Remover acentos para compatibilidade
      const nomeSemAcentos = removerAcentos(professor.split(' ')[0]).toUpperCase();
      
      if (!horariosProfessores[nomeSemAcentos]) {
        aulaContainer.innerHTML = '<p>Professor sem horários cadastrados</p>';
        return;
      }
      
      const aulasProfessor = horariosProfessores[nomeSemAcentos][periodo] || [];
      if (aulasProfessor.length === 0) {
        aulaContainer.innerHTML = '<p>Não há aulas neste período</p>';
        return;
      }
      
      // Obter dia da semana (0 = Domingo, 1 = Segunda, ...)
      const [dia, mes, ano] = data.split('/');
      const dataObj = new Date(ano, mes-1, dia);
      const diaSemana = dataObj.getDay();
      
      // Não exibir aulas para domingo e sábado (0 e 6)
      if (diaSemana === 0 || diaSemana === 6) {
        aulaContainer.innerHTML = '<p>Não há aulas disponíveis para domingos e sábados</p>';
        return;
      }
      
      // Número de aulas por dia de acordo com o período
      let aulasPorDia = 0;
      if (periodo === "MANHA" || periodo === "TARDE") {
        aulasPorDia = 6;
      } else if (periodo === "NOITE") {
        aulasPorDia = 5;
      }
      
      // Índice do primeiro horário do dia
      let indiceInicio = (diaSemana - 1) * aulasPorDia;
      
      // Prevenção contra índices inválidos
      if (indiceInicio < 0) {
        indiceInicio = 0;
      } else if (indiceInicio >= aulasProfessor.length) {
        indiceInicio = aulasProfessor.length - aulasPorDia;
        if (indiceInicio < 0) indiceInicio = 0;
      }
      
      const aulasDoDia = aulasProfessor.slice(indiceInicio, indiceInicio + aulasPorDia);
      
      if (aulasDoDia.length === 0) {
        aulaContainer.innerHTML = '<p>Não há aulas disponíveis neste dia</p>';
        return;
      }
      
      // Criar checkboxes para as aulas
      aulasDoDia.forEach((aula, index) => {
        // Verificar se a aula não está vazia ou é um horário livre (por exemplo, "X" ou vazio)
        if (aula && aula.trim() !== "" && aula.trim() !== "X") {
          const aulaId = `aula-${index}`;
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = aulaId;
          checkbox.className = "aula-checkbox";
          checkbox.value = aula;
          
          const label = document.createElement("label");
          label.htmlFor = aulaId;
          label.className = "aula-label aula-professor";
          label.textContent = `${aula} (${index+1}ª Aula)`;
          
          aulaContainer.appendChild(checkbox);
          aulaContainer.appendChild(label);
          aulasDisponiveis.push(aula);
        }
      });
    }

    function initDatepicker() {
      const datepickerInput = document.getElementById('dataAgendamento');
      const datepickerPopup = document.getElementById('datepickerPopup');
      const prevMonthBtn = document.getElementById('prevMonth');
      const nextMonthBtn = document.getElementById('nextMonth');
      const datepickerMonthYear = document.getElementById('datepickerMonthYear');
      const datepickerWeekdays = document.getElementById('datepickerWeekdays');
      const datepickerDays = document.getElementById('datepickerDays');

      datepickerWeekdays.innerHTML = weekdays.map(day => 
        `<div class="datepicker-weekday">${day}</div>`
      ).join('');

      datepickerInput.addEventListener('click', () => {
        datepickerPopup.classList.toggle('active');
        renderDatepicker();
      });

      prevMonthBtn.addEventListener('click', () => {
        currentPopupDate.setMonth(currentPopupDate.getMonth() - 1);
        renderDatepicker();
      });

      nextMonthBtn.addEventListener('click', () => {
        currentPopupDate.setMonth(currentPopupDate.getMonth() + 1);
        renderDatepicker();
      });

      document.addEventListener('click', (e) => {
        if (!datepickerPopup.contains(e.target) && e.target !== datepickerInput) {
          datepickerPopup.classList.remove('active');
        }
      });

      function renderDatepicker() {
        const year = currentPopupDate.getFullYear();
        const month = currentPopupDate.getMonth();
        
        datepickerMonthYear.textContent = `${monthNames[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        let daysHtml = '';
        const today = new Date();
        
        for (let i = 0; i < firstDay; i++) {
          daysHtml += `<div class="datepicker-day datepicker-other-month disabled">${daysInPrevMonth - firstDay + i + 1}</div>`;
        }
        
        for (let i = 1; i <= daysInMonth; i++) {
          const date = new Date(year, month, i);
          const isToday = date.toDateString() === today.toDateString();
          const isSelected = popupSelectedDate && date.toDateString() === popupSelectedDate.toDateString();
          const isPast = date < new Date(today.getFullYear(), today.getMonth(), today.getDate());
          
          let dayClass = 'datepicker-day';
          if (isToday) dayClass += ' today';
          if (isSelected) dayClass += ' selected';
          if (isPast) dayClass += ' disabled';
          
          daysHtml += `<div class="${dayClass}" data-day="${i}">${i}</div>`;
        }
        
        const totalCells = 42;
        const remainingCells = totalCells - (firstDay + daysInMonth);
        for (let i = 1; i <= remainingCells; i++) {
          daysHtml += `<div class="datepicker-day datepicker-other-month disabled">${i}</div>`;
        }
        
        datepickerDays.innerHTML = daysHtml;
        
        document.querySelectorAll('.datepicker-day:not(.disabled)').forEach(day => {
          day.addEventListener('click', () => {
            const dayNum = parseInt(day.getAttribute('data-day'));
            popupSelectedDate = new Date(year, month, dayNum);
            
            const formattedDay = String(dayNum).padStart(2, '0');
            const formattedMonth = String(month + 1).padStart(2, '0');
            selectedDate = `${formattedDay}/${formattedMonth}/${year}`;
            datepickerInput.value = selectedDate;
            
            datepickerPopup.classList.remove('active');
            updateMainCalendarSelection(year, month + 1, dayNum);
            atualizarAulasDisponiveis();
          });
        });
      }
      
      renderDatepicker();
    }

    function updateMainCalendarSelection(year, month, day) {
      if (parseInt(yearSelect.value) !== year || parseInt(monthSelect.value) + 1 !== month) {
        yearSelect.value = year;
        monthSelect.value = month - 1;
        renderCalendarBody(year, month - 1);
      }
      
      const calendarBody = document.getElementById('calendarBody');
      const cells = calendarBody.querySelectorAll('td');
      
      cells.forEach(cell => {
        if (parseInt(cell.textContent) === day) {
          if (selectedDay) {
            selectedDay.classList.remove('selecionado');
            const agendamentosDoMes = getAgendamentos(parseInt(yearSelect.value), parseInt(monthSelect.value));
            if (!agendamentosDoMes.find(d => d.dia === parseInt(selectedDay.textContent))) {
              selectedDay.classList.add('disponivel');
            }
          }
          
          cell.classList.add('selecionado');
          cell.classList.remove('disponivel');
          selectedDay = cell;
        }
      });
    }

    function populateMonthYearSelectors() {
      const currentYear = new Date().getFullYear();

      monthSelect.innerHTML = '';
      yearSelect.innerHTML = '';

      for (let y = currentYear - 1; y <= currentYear + 2; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      }

      monthNames.forEach((name, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = name;
        monthSelect.appendChild(option);
      });

      const now = new Date();
      monthSelect.value = now.getMonth();
      yearSelect.value = now.getFullYear();
    }

    function getAgendamentos(year, month) {
      const key = `${year}-${String(month + 1).padStart(2, '0')}`;
      return agendamentos[key] || [];
    }

    async function renderHistorico(agendamentosDoMes) {
      const historicoBody = document.getElementById('historico-body');
      historicoBody.innerHTML = '';
      
      agendamentosDoMes.forEach(({ dia, aparelho, professor, turma, numAparelhos, aula, horaEntrega, id }) => {
        const row = document.createElement('tr');
        
        const formattedDay = String(dia).padStart(2, '0');
        const formattedMonth = String(parseInt(monthSelect.value) + 1).padStart(2, '0');
        const formattedDate = `${formattedDay}/${formattedMonth}/${yearSelect.value}`;
        const dataAgendamento = formatarDataParaComparacao(dia, parseInt(monthSelect.value) + 1, yearSelect.value);
        
        if (horaEntrega) {
          row.classList.add('entregue');
        } else {
          row.classList.add('nao-entregue');
        }
        
        if (estaDentroDoPeriodo(dataAgendamento)) {
          row.classList.add('recente');
        }
        
        if (!estaDentroDoPeriodo(dataAgendamento)) {
          row.classList.add('expirado');
        }
        
        row.innerHTML = `
          <td>${formattedDate}</td>
          <td>${turma}</td>
          <td>${numAparelhos}</td>
          <td>${aparelho}</td>
          <td>${professor}</td>
          <td>${aula}</td>
          <td>${horaEntrega || 'Não entregue'}</td>
          <td>
            ${!horaEntrega ? `<button class="btn btn-entregar" onclick="abrirModalDevolucao('${id}')">ENTREGAR</button>` : ''}
            <button class="btn btn-excluir" onclick="excluirAgendamento('${id}')" ${!estaDentroDoPeriodo(dataAgendamento) ? 'disabled' : ''}>EXCLUIR</button>
          </td>
        `;
        historicoBody.appendChild(row);
      });
      
      const currentMonthKey = `${yearSelect.value}-${String(parseInt(monthSelect.value) + 1).padStart(2, '0')}`;
      historicoExcluidos
        .filter(item => item.mesAno === currentMonthKey)
        .forEach(({ dia, aparelho, professor, turma, numAparelhos, aula, horaEntrega, dataExclusao }) => {
          const row = document.createElement('tr');
          row.classList.add('excluido');
          
          const formattedDay = String(dia).padStart(2, '0');
          const formattedMonth = String(parseInt(monthSelect.value) + 1).padStart(2, '0');
          const formattedDate = `${formattedDay}/${formattedMonth}/${yearSelect.value}`;
          const dataAgendamento = formatarDataParaComparacao(dia, parseInt(monthSelect.value) + 1, yearSelect.value);
          
          if (estaDentroDoPeriodo(dataAgendamento)) {
            row.classList.add('recente');
          }
          
          if (!estaDentroDoPeriodo(dataAgendamento)) {
            row.classList.add('expirado');
          }
          
          row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${turma}</td>
            <td>${numAparelhos}</td>
            <td>${aparelho}</td>
            <td>${professor}</td>
            <td>${aula}</td>
            <td>${horaEntrega || 'Não entregue'}</td>
            <td>EXCLUÍDO</td>
          `;
          historicoBody.appendChild(row);
        });
    }

    function renderCalendarBody(year, month) {
      const calendarBody = document.getElementById('calendarBody');
      calendarBody.innerHTML = '';

      const date = new Date(year, month, 1);
      const firstDay = date.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();

      const agendamentosDoMes = getAgendamentos(year, month);

      let day = 1;
      let currentRow = document.createElement('tr');
      
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('td');
        emptyCell.innerHTML = daysInPrevMonth - firstDay + i + 1;
        emptyCell.classList.add('indisponivel');
        currentRow.appendChild(emptyCell);
      }

      while (day <= daysInMonth) {
        if (currentRow.children.length === 7) {
          calendarBody.appendChild(currentRow);
          currentRow = document.createElement('tr');
        }

        const cell = document.createElement('td');
        cell.textContent = day;

        const agendado = agendamentosDoMes.find(d => d.dia === day);
        if (agendado) {
          cell.classList.add('agendado');
          cell.title = `${agendado.aparelho} - ${agendado.professor}`;
        } else {
          cell.classList.add('disponivel');
          cell.style.cursor = 'default';
        }

        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
          cell.style.border = '2px solid var(--azul-escuro)';
          cell.style.fontWeight = 'bold';
        }

        currentRow.appendChild(cell);
        day++;
      }

      while (currentRow.children.length < 7) {
        const nextMonthDay = document.createElement('td');
        nextMonthDay.innerHTML = day - daysInMonth;
        nextMonthDay.classList.add('indisponivel');
        currentRow.appendChild(nextMonthDay);
        day++;
      }

      if (currentRow.children.length > 0) {
        calendarBody.appendChild(currentRow);
      }

      renderHistorico(agendamentosDoMes);
    }

    async function agendarEquipamento() {
      const professor = document.getElementById("professor").value;
      const aparelho = document.getElementById("equipamentoAgendamento").value;
      const turma = document.getElementById("studentClass").value;
      const numAparelhos = parseInt(document.getElementById("quantidadeAgendamento").value);
      const sala = document.getElementById("sala").value;
      const data = document.getElementById("dataAgendamento").value;
      
      // Obter aulas selecionadas
      const aulasSelecionadas = [];
      document.querySelectorAll('.aula-checkbox:checked').forEach(checkbox => {
        aulasSelecionadas.push(checkbox.value);
      });
      
      if (!professor || professor === "Selecione" || !aparelho || !turma || !numAparelhos || !data || !sala || aulasSelecionadas.length === 0) {
        alert("Preencha todos os campos obrigatórios do formulário antes de agendar!");
        return;
      }
      
      const [dia, mes, ano] = data.split('/');
      const mesAno = `${ano}-${mes}`;
      
      // Criar um agendamento para cada aula selecionada
      for (const aula of aulasSelecionadas) {
        // Verificar conflito para esta aula específica
        if (await verificarConflitoAgendamento(turma, data, aula)) {
          alert(`Já existe um agendamento para esta turma nesta data e aula (${aula})!`);
          continue;
        }
        
        const novoAgendamento = { 
          dia: parseInt(dia),
          mesAno,
          aparelho,
          professor,
          turma,
          numAparelhos,
          aula,
          sala,
          horaEntrega: null
        };
        
        const sucesso = await salvarAgendamentoFirestore(novoAgendamento);
        
        if (sucesso) {
          if (!agendamentos[mesAno]) {
            agendamentos[mesAno] = [];
          }
          agendamentos[mesAno].push({ id: sucesso, ...novoAgendamento });
        } else {
          alert("Erro ao salvar agendamento. Tente novamente.");
        }
      }
      
      // Atualizar calendário e histórico
      renderCalendarBody(parseInt(ano), parseInt(mes) - 1);
      
      if (selectedDay) {
        selectedDay.classList.remove('selecionado');
        selectedDay.classList.add('agendado');
        selectedDay = null;
      }
      selectedDate = null;
      document.getElementById('dataAgendamento').value = '';
      
      alert("Agendamentos cadastrados com sucesso!");
    }

    async function excluirAgendamento(id) {
      if (!confirm("Tem certeza que deseja excluir este agendamento?")) {
        return;
      }
      
      for (const key in agendamentos) {
        const index = agendamentos[key].findIndex(ag => ag.id === id);
        if (index !== -1) {
          const [agendamentoExcluido] = agendamentos[key].splice(index, 1);
          
          const sucesso = await excluirAgendamentoFirestore(id, agendamentoExcluido);
          if (sucesso) {
            await carregarDadosIniciais();
          } else {
            alert("Erro ao excluir agendamento. Tente novamente.");
          }
          break;
        }
      }
    }
    
    function abrirModalDevolucao(id) {
      for (const key in agendamentos) {
        const agendamento = agendamentos[key].find(ag => ag.id === id);
        if (agendamento) {
          agendamentoParaDevolver = agendamento;
          
          document.getElementById('modalText').textContent = 
            `Confirmar devolução de ${agendamento.numAparelhos} ${agendamento.aparelho}(s) pelo professor ${agendamento.professor}?`;
          
          const now = new Date();
          const horaAtual = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          document.getElementById('horaEntregaModal').value = horaAtual;
          
          document.getElementById('devolucaoModal').style.display = 'block';
          break;
        }
      }
    }
    
    function fecharModal() {
      document.getElementById('devolucaoModal').style.display = 'none';
      agendamentoParaDevolver = null;
    }
    
    async function finalizarAgendamento() {
      if (!agendamentoParaDevolver) return;
      
      const horaEntrega = document.getElementById('horaEntregaModal').value;
      if (!horaEntrega) {
        alert("Informe a hora da entrega!");
        return;
      }
      
      const sucesso = await atualizarAgendamentoFirestore(agendamentoParaDevolver.id, { horaEntrega });
      if (sucesso) {
        agendamentoParaDevolver.horaEntrega = horaEntrega;
        
        const [ano, mes] = agendamentoParaDevolver.mesAno.split('-');
        renderCalendarBody(parseInt(ano), parseInt(mes) - 1);
        
        fecharModal();
        alert("Devolução registrada com sucesso!");
      } else {
        alert("Erro ao registrar devolução. Tente novamente.");
      }
    }

    function gerarDocumentoPDF(agendamento) {
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.setTextColor(10, 36, 99);
      doc.text("TERMO DE EMPRÉSTIMO DE EQUIPAMENTOS", 105, 20, null, null, 'center');
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text("ESCOLA ESTADUAL - NOME DA ESCOLA", 105, 30, null, null, 'center');
      doc.text("Departamento de Tecnologia", 105, 36, null, null, 'center');
      
      doc.setDrawColor(10, 36, 99);
      doc.setLineWidth(0.5);
      doc.line(20, 42, 190, 42);
      
      doc.setFontSize(12);
      doc.text("PROFESSOR: " + agendamento.professor, 20, 50);
      doc.text("EMAIL: " + (teacherEmails[agendamento.professor] || "Não informado"), 20, 58);
      
      doc.text("TURMA: " + agendamento.turma, 20, 66);
      doc.text("SALA: " + agendamento.sala, 20, 74);
      
      doc.text("EQUIPAMENTO: " + agendamento.aparelho + " - " + marcas[agendamento.aparelho], 20, 82);
      doc.text("QUANTIDADE: " + agendamento.numAparelhos, 20, 90);
      
      const dataFormatada = `${agendamento.dia.toString().padStart(2, '0')}/${(parseInt(monthSelect.value) + 1).toString().padStart(2, '0')}/${yearSelect.value}`;
      doc.text("DATA: " + dataFormatada, 20, 98);
      doc.text("AULA: " + agendamento.aula, 20, 106);
      
      doc.text("HORA DE ENTREGA: " + (agendamento.horaEntrega || "Não entregue"), 20, 114);
      
      doc.line(20, 122, 190, 122);
      
      doc.setFontSize(10);
      doc.text("DECLARO QUE RECEBI O(S) EQUIPAMENTO(S) EM PERFEITO ESTADO E ME COMPROMETO A:", 20, 130);
      doc.text("- Utilizar o(s) equipamento(s) exclusivamente para fins pedagógicos;", 25, 138);
      doc.text("- Zelar pela conservação e segurança do(s) equipamento(s);", 25, 146);
      doc.text("- Devolver o(s) equipamento(s) no prazo combinado;", 25, 154);
      doc.text("- Comunicar imediatamente qualquer problema ou dano ocorrido.", 25, 162);
      
      doc.setFontSize(12);
      doc.text("__________________________________________", 50, 180);
      doc.text("Assinatura do Professor", 105, 188, null, null, 'center');
      
      const agora = new Date();
      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text(`Documento gerado em: ${agora.toLocaleString()}`, 105, 285, null, null, 'center');
      
      const nomeArquivo = `Termo_${agendamento.professor.replace(/\s+/g, '_')}_${dataFormatada.replace(/\//g, '-')}.pdf`;
      doc.save(nomeArquivo);
    }
    
    function exportarParaPDF() {
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.setTextColor(10, 36, 99);
      doc.text("RELATÓRIO DE AGENDAMENTOS", 105, 20, null, null, 'center');
      
      doc.setFontSize(12);
      doc.text(`Período: ${monthNames[parseInt(monthSelect.value)]} de ${yearSelect.value}`, 105, 30, null, null, 'center');
      
      const agendamentosDoMes = getAgendamentos(parseInt(yearSelect.value), parseInt(monthSelect.value));
      
      if (agendamentosDoMes.length === 0) {
        doc.setFontSize(12);
        doc.text("Nenhum agendamento encontrado para este período.", 105, 40, null, null, 'center');
      } else {
        const headers = [
          "Data", 
          "Turma", 
          "Qtd", 
          "Equipamento", 
          "Professor", 
          "Aula", 
          "Entrega"
        ];
        
        const data = agendamentosDoMes.map(ag => {
          const diaFormatado = ag.dia.toString().padStart(2, '0');
          const mesFormatado = (parseInt(monthSelect.value) + 1).toString().padStart(2, '0');
          return [
            `${diaFormatado}/${mesFormatado}/${yearSelect.value}`,
            ag.turma,
            ag.numAparelhos.toString(),
            ag.aparelho,
            ag.professor,
            ag.aula,
            ag.horaEntrega || "Não entregue"
          ];
        });
        
        doc.autoTable({
          head: [headers],
          body: data,
          startY: 40,
          theme: 'grid',
          headStyles: {
            fillColor: [10, 36, 99],
            textColor: 255,
            fontStyle: 'bold'
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240]
          },
          margin: { top: 40 }
        });
      }
      
      const agora = new Date();
      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text(`Relatório gerado em: ${agora.toLocaleString()}`, 105, 285, null, null, 'center');
      
      const nomeArquivo = `Relatorio_Agendamentos_${monthNames[parseInt(monthSelect.value)]}_${yearSelect.value}.pdf`;
      doc.save(nomeArquivo);
    }
    
    function exportarParaCSV() {
      const agendamentosDoMes = getAgendamentos(parseInt(yearSelect.value), parseInt(monthSelect.value));
      
      if (agendamentosDoMes.length === 0) {
        alert("Nenhum agendamento encontrado para este período.");
        return;
      }
      
      let csv = "Data,Turma,Quantidade,Equipamento,Professor,Aula,Hora Entrega,Sala\n";
      
      agendamentosDoMes.forEach(ag => {
        const diaFormatado = ag.dia.toString().padStart(2, '0');
        const mesFormatado = (parseInt(monthSelect.value) + 1).toString().padStart(2, '0');
        const data = `${diaFormatado}/${mesFormatado}/${yearSelect.value}`;
        
        csv += `"${data}","${ag.turma}","${ag.numAparelhos}","${ag.aparelho}","${ag.professor}","${ag.aula}","${ag.horaEntrega || ''}","${ag.sala}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `Agendamentos_${monthNames[parseInt(monthSelect.value)]}_${yearSelect.value}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function limparFormulario() {
      document.getElementById("professor").value = "Selecione";
      document.getElementById("email-professor").value = "";
      document.getElementById("equipamentoAgendamento").value = "";
      document.getElementById("marca").value = "";
      document.getElementById("quantidadeAgendamento").value = "1";
      document.getElementById("studentClass").value = "";
      document.getElementById("sala").value = "";
      document.getElementById("aula-container").innerHTML = '';
      document.getElementById("conflictMessage").style.display = "none";
      
      if (selectedDay) {
        selectedDay.classList.remove('selecionado');
        const agendamentosDoMes = getAgendamentos(parseInt(yearSelect.value), parseInt(monthSelect.value));
        if (!agendamentosDoMes.find(d => d.dia === parseInt(selectedDay.textContent))) {
          selectedDay.classList.add('disponivel');
        }
        selectedDay = null;
      }
      selectedDate = null;
      document.getElementById('dataAgendamento').value = '';
      popupSelectedDate = null;
    }

    // Inicialização
    async function initApp() {
      gerarOpcoesProfessores();
      populateMonthYearSelectors();
      await carregarDadosIniciais();
      initDatepicker();

      document.getElementById("professor").addEventListener("change", atualizarEmailEAulas);
      document.getElementById("studentClass").addEventListener("change", atualizarSalaEAulas);
      document.getElementById("dataAgendamento").addEventListener("change", atualizarAulasDisponiveis);

      monthSelect.addEventListener('change', () => {
        renderCalendarBody(Number(yearSelect.value), Number(monthSelect.value));
      });

      yearSelect.addEventListener('change', () => {
        renderCalendarBody(Number(yearSelect.value), Number(monthSelect.value));
      });

      // Carregar as aulas disponíveis ao iniciar (se houver dados preenchidos)
      atualizarAulasDisponiveis();
    }

    initApp();
  </script>
</body>
</html>
